name: Test

on: [push]

jobs:
  matrix-output:
    runs-on: ubuntu-latest
    name: Create matrix based on directories
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Create matrix
      id: matrix
      run: |
        echo "matrix=$(jq -njc --arg dirs "$(git diff --dirstat=files,0 origin/master -- | sed -E 's/[ 0-9.]+% //g' | cut -d'/' -f1,2 | sort -u | grep -v '.github/')" '$dirs | split("\n")')" >> "$GITHUB_OUTPUT"

  test:
    runs-on: ubuntu-latest
    name: Test port
    needs: matrix-output
    if: needs.matrix-output.outputs.matrix != '[]'
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
        #POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        port: ${{ fromJson(needs.matrix-output.outputs.matrix) }}
        freebsd:
          - "13.4"
          - "14.1"
          - "14.2"
    steps:
    - uses: actions/checkout@v4
    - name: Run tests
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        usesh: true
        nat: |
          "5432": "5432"
        release: "${{ matrix.freebsd }}"
        prepare: |
          pkg install -y \
            ports-mgmt/porttools

        run: |
          set -e
          echo "::group::Clone ports and configure git"
          git clone --depth 1 https://git.FreeBSD.org/ports.git /usr/ports
          git config --global --add safe.directory "${{ github.GITHUB_WORKSPACE }}"
          echo "::endgroup::"
          echo "::group::portlint"
          (cd ${{ matrix.port }} && /usr/local/bin/portlint -A)
          echo "::endgroup::"
          echo "::group::Install depends"
          make -C ${{ matrix.port }} build-depends-list | cut -c 12- | xargs pkg install -y
          echo "::endgroup::"
          echo "::group::Make test"
          make -C ${{ matrix.port }} test
          echo "::endgroup::"
          echo "::group::Make stage"
          make -C ${{ matrix.port }} stage
          echo "::endgroup::"
          echo "::group::Make check-plist"
          make -C ${{ matrix.port }} check-plist
          echo "::endgroup::"
          echo "::group::Make stage-qa"
          make -C ${{ matrix.port }} stage-qa
          echo "::endgroup::"
